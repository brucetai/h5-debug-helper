<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©•è«–åŠŸèƒ½æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .comment-icon {
            cursor: pointer;
            font-size: 20px;
            margin-left: 10px;
            color: #007bff;
        }
        
        .comment-bubble {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 300px;
        }
        
        .comment-bubble textarea {
            width: 100%;
            min-height: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
        }
        
        .comment-bubble button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
        }
        
        .save-btn {
            background: #007bff;
            color: white;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
        }
        
        .comment-display {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <h1>è©•è«–åŠŸèƒ½æ¸¬è©¦</h1>
    
    <div class="test-item">
        æ¸¬è©¦é …ç›® 1 <span class="comment-icon">ğŸ’¬</span>
    </div>
    
    <div class="test-item">
        æ¸¬è©¦é …ç›® 2 <span class="comment-icon">ğŸ’¬</span>
    </div>
    
    <div class="test-item">
        æ¸¬è©¦é …ç›® 3 <span class="comment-icon">ğŸ’¬</span>
    </div>
    
    <script>
        let commentData = {};
        
        // æ·»åŠ è©•è«–
        function addComment(element) {
            console.log('addComment called', element);
            
            // ç§»é™¤ç¾æœ‰çš„è©•è«–æ°£æ³¡
            const existingBubble = document.querySelector('.comment-bubble');
            if (existingBubble) {
                existingBubble.remove();
            }
            
            // å‰µå»ºè©•è«–æ°£æ³¡
            const bubble = document.createElement('div');
            bubble.className = 'comment-bubble';
            bubble.innerHTML = `
                <textarea placeholder="æ·»åŠ è©•è«–..."></textarea>
                <button class="save-btn">ä¿å­˜</button>
                <button class="cancel-btn">å–æ¶ˆ</button>
            `;
            
            // å®šä½æ°£æ³¡
            const rect = element.getBoundingClientRect();
            bubble.style.left = rect.right + 10 + 'px';
            bubble.style.top = rect.top + 'px';
            
            // æ·»åŠ åˆ°é é¢
            document.body.appendChild(bubble);
            
            // èšç„¦åˆ°æ–‡æœ¬æ¡†
            const textarea = bubble.querySelector('textarea');
            textarea.focus();
            
            // ä¿å­˜å¼•ç”¨
            bubble.dataset.element = element;
            
            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            const saveBtn = bubble.querySelector('.save-btn');
            const cancelBtn = bubble.querySelector('.cancel-btn');
            
            saveBtn.addEventListener('click', function() {
                saveComment(this);
            });
            
            cancelBtn.addEventListener('click', function() {
                cancelComment(this);
            });
        }
        
        // ä¿å­˜è©•è«–
        function saveComment(button) {
            const bubble = button.closest('.comment-bubble');
            const textarea = bubble.querySelector('textarea');
            const element = bubble.dataset.element;
            
            if (textarea.value.trim()) {
                const comment = {
                    text: textarea.value.trim(),
                    time: new Date().toLocaleString()
                };
                
                // é¡¯ç¤ºè©•è«–
                showComment(element, comment);
                
                // ä¿å­˜åˆ°æœ¬åœ°
                const key = element.textContent.trim();
                commentData[key] = comment;
                localStorage.setItem('testCommentData', JSON.stringify(commentData));
                
                alert('è©•è«–å·²ä¿å­˜ï¼');
            }
            
            bubble.remove();
        }
        
        // å–æ¶ˆè©•è«–
        function cancelComment(button) {
            button.closest('.comment-bubble').remove();
        }
        
        // é¡¯ç¤ºè©•è«–
        function showComment(element, comment) {
            // ç§»é™¤ç¾æœ‰è©•è«–é¡¯ç¤º
            const existingDisplay = element.parentNode.querySelector('.comment-display');
            if (existingDisplay) {
                existingDisplay.remove();
            }
            
            // å‰µå»ºè©•è«–é¡¯ç¤º
            const display = document.createElement('div');
            display.className = 'comment-display';
            display.innerHTML = `
                <div><strong>æ™‚é–“ï¼š</strong>${comment.time}</div>
                <div><strong>è©•è«–ï¼š</strong>${comment.text}</div>
            `;
            
            // æ’å…¥åˆ°å…ƒç´ å¾Œé¢
            element.parentNode.insertBefore(display, element.nextSibling);
        }
        
        // é é¢è¼‰å…¥å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            // è¼‰å…¥å·²ä¿å­˜çš„è©•è«–
            const savedData = localStorage.getItem('testCommentData');
            if (savedData) {
                try {
                    commentData = JSON.parse(savedData);
                    console.log('Loaded comment data:', commentData);
                } catch (e) {
                    console.log('Failed to load comment data');
                }
            }
            
            // ç‚ºæ‰€æœ‰è©•è«–åœ–æ¨™æ·»åŠ é»æ“Šäº‹ä»¶
            document.querySelectorAll('.comment-icon').forEach(icon => {
                console.log('Adding click listener to icon:', icon);
                icon.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Icon clicked:', this);
                    addComment(this);
                });
            });
            
            console.log('Event listeners added');
        });
    </script>
</body>
</html>
